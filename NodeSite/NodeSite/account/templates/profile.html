{% extends 'base.html' %}
{% load i18n static %}
{% load compressed %}

{% block extra_css %}
{% compressed_css 'account' %}
{% endblock%}

{% block content %}

<div id="account-manage">

  <ul id="manage-tab" class="nav nav-tabs">
    <li class="active"><a href="#profile">账户基本信息</a></li>
    <li><a href="#change-password">更改密码</a></li>
    <li><a href="#letters">站内信</a></li>
  </ul>
  
  <div id="context" class="tab-content">
    <div id="profile" class="tab-pane active">
      <form class="form form-horizontal" role="form" >
        <div id="errors" style='display:none'> </div>
        <input type="hidden" name="uid" value="{{request.user.id}}" />
        <div class="form-group">
          <label for="username" class="col-sm-2 control-label">用户名</label>
          <div class="col-sm-10">
            <input type="text" class="form-control" id="username" name="username" placeholder="用户名" value="{{username}}" disabled>
          </div>
        </div>

        <div class="form-group">
          <label for="email" class="col-sm-2 control-label">电子邮件</label>
          <div class="col-sm-10">
            <input type="email" class="form-control" id="email" name="email" placeholder="电子邮件" value="{{email}}">
          </div>
        </div>

        <div class="form-group">
          <label for="phone" class="col-sm-2 control-label">手机号码</label>
          <div class="col-sm-10">
            <input type="text" class="form-control" id="phone" name="phone" placeholder="手机号码" value="{{phone}}">
          </div>
        </div>

        <div class="form-group">
          <label for="group" class="col-sm-2 control-label">所在组</label>
          <div class="col-sm-10">
            <input type="text" class="form-control" id="group" name="group" placeholder="所在组" value="{{group}}" disabled>
          </div>
        </div>
        <button class="btn btn-success" type="submit" style="float: right;">确认修改</button>
      </form>

    </div> 

    <div id="change-password" class="tab-pane">
      <form id="password-change-form" class="form" role="form">{% csrf_token %}

        <div class="errors"></div> 

        {{ passwordChangeForm.as_p }}

        <button class="btn btn-success" type="submit">更改</button>
      </form>
    </div> 

    <div id="letters" class="tab-pane">
      <div id="errors"></div> 
      <form method="POST" id="" action="" class="">
        <div class="form-group">
          <label for="recipients">收件人</label>
          <input type="text" class="form-control" id="recipients" placeholder="收件人">
        </div>
        <div class="form-group">
          <label for="message">输入信息</label>
          <textarea class="form-control" rows="3" id="message" placeholder="请输入信息"></textarea>
        </div>
      </form>
    </div> 
  </div> 

</div> 

<script type="text/javascript">
$(function() {

    $('#manage-tab a').click(function (e) {
        e.preventDefault()
        $(this).tab('show')
    })

    // 修改基本信息
    function modifyProfile(data) {
        var $errors = $('#profile #errors')
        var wrapper_prefix = "<div class='alert alert-danger alert-dismissable'>"
        var wrapper_affix = "</div>"
        var btnClose = "<button type=button class=close data-dismiss=alert aria-hidden=true>&times;</button>"
        var html = ""
        if (data.code === 0)
            data.body = "修改成功"
        html = wrapper_prefix+btnClose+data.body+wrapper_affix
        $errors.show(400).html(html)
    }
    $('#profile form').submit(function(e){
        e.preventDefault()
        var data = $(this).serialize()
        $.ajax({
            url: "{% url 'profile_change' %}",
            type: "PUT",
            data: data,
            success: modifyProfile,
            fail: function () { alert("连接服务器失败，请检查网络连接。") }
        })
    })

    // 表单提交逻辑，修改密码
    var $passwordChangeForm = $('#password-change-form')
    var $errors = $('.errors', $passwordChangeForm)
    $passwordChangeForm.submit(function(e){
        e.preventDefault()
        // console.log ($(this).serialize())
        $.ajax({
            url:"{% url 'password_change' %}",
            type: "POST",
            data: $(this).serialize(),
            success: function(data) {
                console.log(data)
                $errors.html(data.body)
            },
            fail: function(e) {
                console.log(arguments)
                $errors.html(e)
            },
        })
    })

})
</script>

{% endblock %}


<!-- {% if passwordChangeForm.errors %} -->
<!--     <p class="errornote"> -->
<!--     {% blocktrans count counter=form.errors.items|length %}Please correct the error below.{% plural %}Please correct the errors below.{% endblocktrans %} -->
<!-- </p> -->
<!--     {% endif %} -->
