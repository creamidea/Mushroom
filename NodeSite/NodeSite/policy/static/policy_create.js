// Generated by CoffeeScript 1.7.1
$(function() {
  'use strict';
  var $policyList, $renderTo, from, href, now, nowAlert, nowPos, pid, policyAdd, roomId, _ref;
  href = decodeURI(window.location.search).slice(1);
  _ref = href.split("&&"), from = _ref[0], nowPos = _ref[1], now = _ref[2];
  if (from) {
    pid = from.split('=')[1];
  }
  if (nowPos) {
    nowPos = parseInt(nowPos.split('=')[1], 10);
  }
  if (now) {
    now = now.split('=')[1];
  }
  $renderTo = $('#policy-add');
  if (pid) {
    policyAdd = new Policy(pid, nowPos);
  } else {
    policyAdd = new Policy;
  }
  this.ppAdd = new PolicyPresenter(policyAdd, $renderTo, "edit");
  href = window.location.href;
  roomId = href.match(/.*\?roomId=(\d+)$/);
  if (roomId) {
    roomId = roomId[1];
  }
  $policyList = $('#policy-list');
  if (roomId) {
    $.ajax({
      url: "/policy/room/" + roomId + "/",
      type: "GET",
      success: function(data) {
        var html, source, template;
        source = $("#policy-list-template").html();
        template = Handlebars.compile(source);
        html = template({
          policys: data.body
        });
        return $policyList.html(html);
      },
      fail: function() {
        return alert("获取房间" + roomId + "的策略失败，请检查网络连接！");
      }
    });
  }
  $('#create-policy-form').submit(function(e) {
    var $form, description, rules;
    if (e) {
      e.preventDefault();
    }
    if (!confirm("提交之后不能修改，只能新建，请仔细检查。")) {
      return 0;
    }
    $form = $(this);
    description = $('input#description', $form).val();
    rules = policyAdd.data;
    if (description === "" || rules.length === 0) {
      alert("描述，策略不能为空");
      return 0;
    }
    return $.ajax({
      url: "/policy/create/",
      type: "POST",
      data: {
        description: description,
        rules: JSON.stringify(rules)
      },
      success: function(data) {
        if (data.code === 0) {
          return window.location.href = "/policy/" + data.body + "/";
        } else {
          return alert(data.body);
        }
      },
      fail: function() {
        return alert("创建策略失败，请检查网络连接。");
      }
    });
  });
  if (nowPos >= 0) {
    nowAlert = "<div class=\"alert alert-warning alert-dismissable\"> <button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-hidden=\"true\">&times;</button> 以下从可以编辑的地方开始，都是相对<strong style=\"font-size: 1.2em; color: black;\">" + now + "</strong>进行的，请格外注意。 还有请注意编辑的速度，避免造成贻误现象出现。 </div> ";
    $('.policy').prepend(nowAlert);
  }
});
