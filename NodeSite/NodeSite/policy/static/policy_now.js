// Generated by CoffeeScript 1.7.1
'use strict';
$(function() {
  var $policyNow, href, roomId;
  href = window.location.href;
  roomId = href.match(/.*room\/(\d+)\//);
  $policyNow = $('#policy-now');
  if (roomId) {
    roomId = roomId[1];
    $.ajax({
      url: "/policy/now/room/" + roomId + "/",
      type: 'GET',
      success: function(data) {
        var body, html, now, nowPos, policyId, roomDesc, rules, source, template, _ref;
        console.log(data);
        body = data.body;
        if (body.length < 1) {
          return $policyNow.html("现在还没有数据");
        } else {
          _ref = data.body[0], policyId = _ref.policyId, roomId = _ref.roomId, roomDesc = _ref.roomDesc, now = _ref.now, rules = _ref.rules;
          source = $('#policy-now-template').html();
          template = Handlebars.compile(source);
          html = template({
            roomId: roomId,
            roomDesc: roomDesc,
            context: rules
          });
          $('#policy-now').html(html);
          nowPos = 0;
          $('table tbody', $policyNow).children().each(function(index, elt) {
            var $date, $elt, $i;
            $elt = $(elt);
            $date = $('td.date', $elt);
            if ($date.text() === now) {
              nowPos = index;
              html = "<i class=\"glyphicon glyphicon-forward\"></i>";
              $date.prepend(html);
              $i = $date.find('i');
              return $i.css("position", "absolute").css("left", "10px").css("top", "10px");
            }
          });
          return $("#room-" + roomId + " a").attr('href', encodeURI("/policy/create/?from-policy=" + policyId + "&&nowPos=" + nowPos + "&&now=" + now));
        }
      },
      fail: function(data) {
        return alert("通信失败，请检查网络，稍微再试");
      }
    });
  }
});
